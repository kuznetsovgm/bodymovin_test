# Поддержка фоновых слоёв в веб‑конфигураторе

Документ опирается на доменный дизайн из `docs/bg.md` и текущую реализацию пайплайна (`generateSticker` уже строит `backgroundLayers` и `knockoutBackground`). Цель — довести веб‑конфигуратор (`public/config.html`, `public/config.js`, API `src/web-server.ts`) до полноценной работы с фонами.

## Системный анализ
- Бэкенд. Типы `backgroundLayers`/`knockoutBackground` уже есть в `GenerateStickerOptions`, пайплайн умеет `Solid`, `Frame`, `Stripes` и базовый knockout. `/api/preview` принимает `config: Omit<GenerateStickerOptions, 'text'>`, но UI эти поля не формирует.
- UI. `config.js` рендерит только текстовые анимации, строит первый элемент каждого массива анимаций и перезаписывает `config`. В состоянии и сериализации нет упоминаний фоновых полей, поэтому любые фоновые настройки потеряются при загрузке/сохранении.
- Meta. `/api/meta` сейчас отдаёт только enum’ы анимаций и дефолты; информации о `BackgroundLayerType`, параметрах фонов и safe‑дефолтах нет — UI нечем заполнить select/placeholder для фоновых полей.
- Хранение. `StickerConfigManager` сохраняет всё, что пришло от клиента (кроме width/height/fontSize). Новые поля будут сохранены автоматически, важно корректно сериализовать/десериализовать на фронте.
- Совместимость. Фоновые поля опциональны и должны быть обратимо совместимы: старые конфиги без фонов продолжают открываться и сохраняться без изменений.

## План внедрения
### 1) Расширить API meta ✅
- Добавить в ответ `/api/meta`:
  - `backgroundLayerTypes`: массив доступных типов (`solid`, `frame`, `stripes`, `glyphPattern`, `textLike`) и их человекочитаемые лейблы.
  - `knockoutModes`: `fill`/`stroke`.
  - `backgroundParamMeta`: описание параметров для UI (min/max/step/hint) для `Solid` (`paddingFactor`, `cornerRadius`), `Frame` (толщина обводки в stroke‑params, padding), `Stripes` (`count`, `stripeHeightFactor`, `gapFactor`, `cornerRadius`), задел под `glyphPattern`/`textLike`.
  - Дефолты безопасных конфигов (например, статичный цвет + strokeWidth=2) для первого layer и knockout.

### 2) Схемы и хелперы на фронте ✅
- В `config.js` завести схемы/мета параметров фона по аналогии с `transformSchema`/`colorSchema`.
- Ввести фабрики нормализации/рендера параметров фоновых слоёв:
  - Базовая структура `BackgroundLayerDescriptor`: type, transform/color/stroke/pathMorph, params (type‑specific), `fontFile`, `text`.
  - Отдельная структура `KnockoutBackgroundOptions` (mode, paddingFactor, cornerRadiusFactor + анимации).
- Переиспользовать существующие рендеры цветов/анимаций для фоновых форм (fill/stroke), чтобы не дублировать UI логики.

### 3) UI секции ✅
- Добавить в `config.html` блок «Фоновые слои»:
  - список слоёв с возможностью добавить/удалить/выбрать слой (упорядочивание опционально — порядок в массиве важен);
  - форма для выбранного слоя: выбор типа, базовые анимации (transform/color/stroke/pathMorph), специфичные параметры (padding, count и т.д.), выбор `fontFile`/`text` для `glyphPattern`/`textLike` (можно пока скрыть/disable для не реализованных типов).
- Добавить блок «Knockout фон»:
  - чекбокс включения;
  - поля: mode (select), paddingFactor, cornerRadiusFactor, color/stroke/pathMorph/transform.

### 4) Сериализация/десериализация ✅
- `getCurrentConfig`: собирать `backgroundLayers` (массив descriptor’ов) и `knockoutBackground` из UI; удалять пустые значения, чтобы не засорять конфиг.
- `loadConfigToForm`: загружать массив фонов и заполнять UI (создавать записи списка, подставлять типы/параметры/цвета/анимации); корректно обрабатывать отсутствие полей.
- `newVariant` reset: инициализировать пустой массив фоновых слоёв и выключенный knockout.
- Следить, чтобы при сохранении/предпросмотре данные уходили в API без мутирования старых полей (глубокие копии, JSON‑сериализация).

### 5) UX и защитные кейсы (частично)
- Предзаполнять новый слой безопасным пресетом: `Solid` с padding 0 и статичной заливкой.
- Для не реализованных типов (`glyphPattern`, `textLike`) — либо скрыть, либо отображать с предупреждением и не включать в сериализацию, пока нет поддержки на UI.
- Валидация числовых полей (clamp 0..1 для факторов, целые для count) перед отправкой.
- Подсветить предупреждения о ресурсоёмких pathMorph/letter анимациях, если они включены на фоне (можно reuse `pathWarnings`).

### 6) Тестирование и проверка (to‑do)
- Ручные сценарии:
  - загрузка существующего конфига без фонов — убедиться, что UI оставляет его без изменений после сохранения;
  - добавление `Solid`/`Frame`/`Stripes` + knockout, предпросмотр и сохранение, повторное открытие — поля восстановились;
  - отключение/включение knockout, проверка even‑odd дырок в предпросмотре;
  - проверка валидации (некорректные числа не ломают отправку).
- Если есть автотесты/линт фронта — прогнать; иначе smoke‑тест UI в браузере.

### 7) Будущие шаги (не блокеры первой итерации)
- Добавить пресеты «мягких» анимаций для фонов (поддержка safe профилей из `bg.md`).
- Поддержать копирование текстовых letter/pathMorph анимаций в knockout‑дырку (флаг «синхронизировать с текстом»).

Этот план закрывает разрыв между реализованными фоновыми слоями в пайплайне и отсутствием управления ими в конфигураторе, сохраняя обратную совместимость с уже сохранёнными конфигами.
