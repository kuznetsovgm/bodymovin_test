# Worker Pool Implementation

## Обзор

Реализована система параллельной генерации стикеров с использованием Worker Pool на базе Node.js Worker Threads. Это позволяет генерировать несколько стикеров одновременно, значительно улучшая производительность бота.

## Архитектура

### Компоненты

1. **Worker Pool** (`src/worker/worker-pool.ts`)

   - Управляет пулом воркеров
   - Распределяет задачи между доступными воркерами
   - Поддерживает очередь задач
   - Автоматическая балансировка нагрузки

2. **Sticker Worker** (`src/worker/sticker-worker.ts`)

   - Отдельный процесс для генерации стикеров
   - Получает задачи от главного процесса
   - Возвращает результаты генерации

3. **Types** (`src/worker/types.ts`)
   - Определения типов для задач и результатов
   - Типы сообщений между процессами

### Как это работает

```
┌─────────────────┐
│   Main Process  │
│    (bot.ts)     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Worker Pool    │
│  - Task Queue   │
│  - Load Balance │
└────────┬────────┘
         │
    ┌────┴────┬────────┬────────┐
    ▼         ▼        ▼        ▼
┌────────┐┌────────┐┌────────┐┌────────┐
│Worker 1││Worker 2││Worker 3││Worker N│
│Generate││Generate││Generate││Generate│
└────────┘└────────┘└────────┘└────────┘
```

## Преимущества

1. **Параллельная обработка**

   - Генерация нескольких стикеров одновременно
   - Использование всех доступных CPU ядер

2. **Масштабируемость**

   - Настраиваемое количество воркеров
   - Очередь задач предотвращает перегрузку

3. **Изоляция**

   - Ошибки в одном воркере не влияют на другие
   - Автоматическое восстановление упавших воркеров

4. **Мониторинг**
   - Метрики для Prometheus
   - Отслеживание производительности каждого воркера

## Конфигурация

### Переменные окружения

```env
# Количество воркеров (по умолчанию: количество CPU)
WORKER_POOL_SIZE=4

# Размер очереди задач (по умолчанию: 100)
WORKER_QUEUE_SIZE=100
```

### Рекомендации

- **WORKER_POOL_SIZE**:

  - Для CPU-bound задач: количество CPU ядер
  - Для I/O-bound задач: 2-3x количество CPU ядер
  - Оставьте пустым для автоматического определения

- **WORKER_QUEUE_SIZE**:
  - Зависит от объема памяти
  - Больше = больше задач в ожидании, но больше потребление памяти
  - 100 - хорошее значение по умолчанию

## Метрики

Новые метрики для мониторинга:

1. `bot_worker_pool_active_workers` - количество активных воркеров
2. `bot_worker_pool_queue_size` - размер очереди задач
3. `bot_worker_task_duration_seconds` - длительность выполнения задачи
4. `bot_worker_tasks_completed_total` - всего выполнено задач

### Grafana Dashboard

Метрики доступны в Grafana на порту 3000:

- Количество активных воркеров
- Размер очереди в реальном времени
- Среднее время выполнения задач
- Throughput (задач в секунду)

## API Worker Pool

### Инициализация

```typescript
const workerPool = new StickerWorkerPool(
  maxWorkers, // Количество воркеров (undefined = auto)
  maxQueueSize, // Размер очереди (по умолчанию: 100)
);

await workerPool.initialize();
```

### Отправка задачи

```typescript
const task: StickerGenerationTask = {
  id: 'unique-task-id',
  text: 'Hello',
  variant: {
    /* sticker config */
  },
  configId: 'config-hash',
  index: 0,
};

const result = await workerPool.submitTask(task);
```

### Пакетная обработка

```typescript
const results = await workerPool.submitBatch(tasks);
```

### Статистика

```typescript
const stats = workerPool.getStats();
console.log(stats);
// {
//   totalWorkers: 4,
//   busyWorkers: 2,
//   idleWorkers: 2,
//   queueSize: 5,
//   tasksCompleted: 120
// }
```

### Остановка

```typescript
await workerPool.shutdown();
```

## Изменения в bot.ts

1. Удален прямой вызов `generateSticker()`
2. Добавлена инициализация Worker Pool при запуске
3. Функция `generateAndCacheStickers()` переписана для использования воркеров
4. Добавлен graceful shutdown с остановкой воркеров

### Пример использования

```typescript
// Старый код (синхронная генерация)
const sticker = await generateSticker(options);

// Новый код (через Worker Pool)
const task = {
  id: crypto.randomBytes(8).toString('hex'),
  text: normalizedText,
  variant: options,
  configId: 'config-id',
  index: 0,
};

const result = await workerPool.submitTask(task);
if (result.success) {
  const sticker = result.sticker;
  // ...
}
```

## Производительность

### До внедрения Worker Pool

- Генерация 5 стикеров: ~15-20 секунд (последовательно)
- 1 стикер использует 100% одного CPU

### После внедрения Worker Pool

- Генерация 5 стикеров: ~4-5 секунд (параллельно на 4 воркерах)
- Все CPU ядра используются эффективно
- Улучшение в 3-4 раза

## Troubleshooting

### Worker падает при запуске

Проверьте, что TypeScript скомпилирован:

```bash
npm run bot  # автоматически компилирует перед запуском
```

### Очередь переполняется

Увеличьте `WORKER_QUEUE_SIZE` или добавьте больше воркеров:

```env
WORKER_POOL_SIZE=8
WORKER_QUEUE_SIZE=200
```

### Высокое потребление памяти

Уменьшите количество воркеров и размер очереди:

```env
WORKER_POOL_SIZE=2
WORKER_QUEUE_SIZE=50
```

## Дальнейшие улучшения

Возможные направления развития:

1. **Приоритезация задач**

   - Разные приоритеты для разных типов анимаций
   - VIP пользователи получают приоритет

2. **Динамическое масштабирование**

   - Автоматическое добавление/удаление воркеров
   - На основе текущей нагрузки

3. **Кластеризация**

   - Распределение воркеров между несколькими серверами
   - Использование Redis для координации

4. **Warm-up воркеров**

   - Предварительная инициализация ресурсов
   - Быстрее первая генерация

5. **Умное кэширование**
   - Предсказание популярных запросов
   - Предварительная генерация стикеров
